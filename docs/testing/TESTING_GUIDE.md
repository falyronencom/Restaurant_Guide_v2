## Руководство по тестированию backend (фазы 1–3)

### Структура и организация
- **Уровни**: unit (сервис/контроллер с моками зависимостей) + integration (API + реальная БД/Redis, фикстуры) + e2e journey (сквозные пользовательские сценарии).
- **Размещение**: `src/tests/unit` для быстрой проверки бизнес-логики; `src/tests/integration` для API/БД; `src/tests/e2e` для сквозных путей. Общие фикстуры и утилиты — `src/tests/fixtures`, `src/tests/utils`, `src/tests/mocks`.
- **Запуск**: `NODE_ENV=test jest --runTestsByPath ...` для целевых наборов; `jest --coverage` для регрессий/метрик.

### Паттерны фикстур БД
- Используйте `createUserAndGetTokens` для аутентифицированных пользователей (partner/regular).
- Очищайте таблицы перед тестом (`TRUNCATE ... CASCADE`) и применяйте изолированные вставки через `query`.
- Для массивов (categories, cuisines) и координат храните валидные значения, соответствующие доменным проверкам.

### Асинхронность и idempotency
- Все тесты `await` HTTP-запросы `supertest` / сервисные вызовы.
- Idempotency: повторный вызов операций add/remove должен быть безопасен (favorites), проверяйте отсутствие дубликатов и стабильные ответы.
- Rate-limit/квоты: используйте mock Redis (`getCounter`, `incrementWithExpiry`) в unit, реальный Redis допускается в integration при наличии.

### Покрытие ошибок и валидаций
- Явно проверяйте коды и тела ошибок: 401/403/404/409/422/429/500 с доменными кодами (`DUPLICATE_REVIEW`, `INVALID_CATEGORIES_LENGTH`, и т.п.).
- Проверяйте constraint/FK/unique ошибки через мокнутые модели (code `23505/23503/23514`), чтобы специфицировать ожидаемые AppError.
- Валидация входа: пагинация (page/limit > 0), UUID-формат, обязательные поля, диапазоны рейтинга/координат/длин контента.

### Авторизация
- Всегда берите `userId`/`partnerId` из `req.user`, игнорируйте тела запросов.
- Negative-path тесты: попытки обновления/удаления чужих ресурсов (reviews, establishments) должны давать 403 или 404 в зависимости от доменной политики.

### Интеграция vs unit
- Unit: мок моделей/Redis/логера; проверка бизнес-веток, кодов ошибок, вызовов зависимостей.
- Integration: реальная БД, полные цепочки контроллер → сервис → модель, проверка статус-кодов и состояния БД (агрегаты, каскадные удаления, статусные переходы).
- E2E journey: связные сценарии (search → favorites → reviews), фиксация известных багов (review update/delete 500) как часть спеки.

### Стратегии для сценариев
- **Idempotent операции**: добавление уже существующего или удаление отсутствующего — успешный ответ без дубликатов.
- **Агрегаты**: после создания/обновления/удаления отзывов проверяйте `average_rating`, `review_count`.
- **Статусы**: при major-изменениях establishments статус сбрасывается в `pending`; submit разрешен только из `draft`.
- **Пагинация/сортировка**: проверяйте `limit`, `offset`, `hasNext/hasPrevious`, корректность сортировки (newest/highest/lowest).

### Практики сопровождения
- Поддерживайте пороги покрытия для ключевых модулей (controllers/services) ≥75–90%.
- Фиксируйте известные отклонения (skip / expected 500) явно в тестах и отчётах.
- Регулярно запускайте `jest --coverage` перед релизами; для локальных быстрых проверок используйте targeted `--runTestsByPath`.

