# Mobile Test_3 Report

**Дата:** 2026-01-20
**Commit:** 26e5fb3

## Цель тестирования
Полное тестирование wizard регистрации партнера (7 шагов), отправка данных на бэкенд, создание заведения.

## Окружение
- **Эмулятор:** Pixel 9a (Android 16, API 36)
- **Бэкенд:** Node.js на 10.0.2.2:3000
- **База данных:** PostgreSQL 15.8 + PostGIS в Docker

## Выявленные проблемы и решения

### 1. Ошибка 422: Несоответствие формата toJson()
**Проблема:** При отправке формы регистрации бэкенд возвращал 422 Validation Error
**Причина:** Flutter `toJson()` отправлял данные в неправильном формате:
- `category` вместо `categories`
- `cuisine_type` вместо `cuisines`
- `city` внутри объекта `address` вместо root level
- `address` как объект вместо строки
- `attributes` как массив вместо объекта
- `working_hours` не отправлялись если не заполнены

**Решение:** Полная переработка `toJson()` в `partner_registration.dart`:
- Добавлены маппинги ID → русские названия для категорий и кухонь
- `city` перемещён на root level
- `address` преобразуется в строку из компонентов
- `attributes` преобразуется в объект `{attr_id: true}`
- Добавлены дефолтные `working_hours` если не указаны
- Исправлено "Могилёв" → "Могилев" для соответствия backend validation

### 2. Ошибка 403: User не может создавать заведения
**Проблема:** Пользователь с ролью 'user' получал 403 Forbidden при создании заведения
**Причина:** Backend route требовал роль 'partner'
**Решение:**
- Изменён `establishmentRoutes.js`: `authorize(['user', 'partner'])`
- Добавлен вызов `upgradeUserToPartner()` в `establishmentService.js` после создания

### 3. Кнопка "Далее" неактивна на шаге 3
**Проблема:** После заполнения BasicInfo кнопка "Далее" не активировалась
**Причина:** Слишком строгая валидация: требовался description 20+ символов, обязательный телефон
**Решение:** Ослаблена валидация в `_validateBasicInfoStep()`:
- name: 2+ символов (было 3+)
- description: опционально (было 20+ символов обязательно)
- phone: опционально (было обязательно)
- priceRange: обязательно (без изменений)

### 4. Ошибка парсинга после успешного 201
**Проблема:** Заведение создавалось (201), но Flutter выбрасывал ошибку парсинга
**Причина:** Формат ответа backend не полностью соответствовал модели Establishment
**Решение:** Добавлен robust парсинг в `establishments_service.dart`:
- try/catch вокруг `Establishment.fromJson()`
- При ошибке парсинга создаётся placeholder Establishment с минимальными данными

### 5. Повторные 409 DUPLICATE_ESTABLISHMENT
**Проблема:** После первого успешного создания пользователь видел ошибку "дубликат" при повторных попытках
**Причина:** UI не показывал успех, пользователь нажимал "Отправить" повторно
**Причина root:** Не решена в этом тесте - UI не навигирует после успеха

## Изменённые файлы

### Backend
- `backend/src/routes/v1/establishmentRoutes.js` — authorize(['user', 'partner'])
- `backend/src/services/authService.js` — добавлена функция upgradeUserToPartner()
- `backend/src/services/establishmentService.js` — вызов upgradeUserToPartner() после создания

### Mobile (Flutter)
- `mobile/lib/models/partner_registration.dart` — переработан toJson(), добавлены маппинги
- `mobile/lib/providers/partner_registration_provider.dart` — ослаблена валидация шага 3
- `mobile/lib/screens/partner/partner_registration_screen.dart` — улучшен debug logging
- `mobile/lib/services/establishments_service.dart` — robust parsing, обработка ошибок

## Результаты тестирования

| Функция | Статус |
|---------|--------|
| Wizard шаг 1: Категория | ✅ Работает |
| Wizard шаг 2: Кухня | ✅ Работает |
| Wizard шаг 3: BasicInfo | ✅ Работает (после fix валидации) |
| Wizard шаг 4: Медиа | ✅ Пропускается |
| Wizard шаг 5: Адрес | ✅ Работает |
| Wizard шаг 6: Юридическая информация | ✅ Работает |
| Wizard шаг 7: Summary | ✅ Работает |
| Отправка на бэкенд | ✅ 201 Created |
| Автоапгрейд user → partner | ✅ Работает (в БД) |
| UI после успеха | ❌ Не навигирует к dashboard |

## Созданные тестовые заведения
- "AI Cafe" — создано успешно
- "AI Restoran" — создано успешно
- "Test Restoran" — создано успешно (20:26:38)

## Нерешённые проблемы (для Test_4)

### UI не обновляется после успешного создания
**Симптом:** После успешного создания (201) пользователь остаётся на том же экране, затем возвращается в профиль где видит кнопку "Разместить заведение" вместо dashboard партнера
**Возможные причины:**
1. Flutter не обновляет роль в auth_provider после создания
2. Navigator не получает pop() после успеха
3. ProfileScreen проверяет роль до обновления состояния

## Следующие шаги (для Test_4)
1. Исправить навигацию после успешного создания заведения
2. Обновить роль в Flutter auth_provider после создания
3. Проверить отображение Partner Dashboard
4. Тестирование редактирования заведения
5. Тестирование статистики и отзывов

## Примечания
- Сессия требовала 3 context compaction из-за объёма изменений
- Backend и Flutter теперь синхронизированы по формату данных
- Заведения создаются корректно, проблема только в UI feedback
