## Troubleshooting Bank (фаза 3)

### Reviews
- **500 на update/delete**: текущий backend отвечает `REVIEW_UPDATE_FAILED` / `REVIEW_DELETION_FAILED`. Тесты фиксируют это как известное состояние. После исправления ожидайте 200/204 и обновите тестовые ожидания.
- **Дубликаты**: ошибка `23505` в БД мапится на `DUPLICATE_REVIEW`; проверяйте уникальный ключ (user_id, establishment_id). В unit мокируйте `findExistingReview` и `createReview`.
- **Квоты**: Redis недоступен → `getCounter` возвращает 0, `incrementWithExpiry` возвращает 1 (fail-open). Используйте мок Redis в unit, в integration — подготовьте Redis или учитывайте поведение по умолчанию.
- **Агрегаты**: при обновлении рейтинга или удалении обязательно вызывайте `updateEstablishmentAggregates`; убедитесь, что тесты проверяют вызов и корректное усреднение.

### Favorites
- **Идемпотентность**: повторное add/remove не должно бросать ошибки. Проверяйте, что `addFavorite` использует ON CONFLICT DO NOTHING, а `removeFavorite` возвращает успех даже при отсутствии записи.
- **Batch check**: ограничение 50 ID; пустой массив — 400/422. В unit проверяйте ошибки `INVALID_INPUT` / `BATCH_TOO_LARGE`.
- **Изоляция пользователей**: операции всегда берут `userId` из токена. Проверяйте, что удаление чужого фаворита не удаляет запись (idempotent delete).

### Establishments
- **Валидация домена**: только города BY, координаты в пределах BY, 1–2 категории, 1–3 кухни. Ошибки → 422 с кодами `INVALID_*`.
- **Дубликаты имени**: `checkDuplicateName` перед созданием/обновлением; для активного статуса major-изменения сбрасывают статус в `pending`.
- **Статусы**: submit разрешён только из `draft`; `suspended` нельзя редактировать; major-изменения в `active` → `pending`. Проверяйте негативные пути (non-owner → 403/404).
- **Формат чисел**: ответы могут содержать строки из Postgres для decimal/float; сервис форматирует в числа. Тесты проверяют преобразование.

### Интеграционные и кросс-модульные замечания
- **Согласованность агрегатов**: изменение отзывов должно отражаться в establishments (avg, count). Проверяйте после операций create/update/delete.
- **E2E сценарии**: search → favorites → reviews — убедитесь, что токены пользователей корректны и статусы заведений `active`, иначе search не вернёт объекты.
- **Пагинация**: следите за `limit` капами (50) и положительными `page`. Ошибки должны возвращать 400/422.
- **Логи/Mock logger**: в unit мокируйте `logger` для подавления шума и проверки вызовов (info/warn/error).

